/**
 * skylark-browserfs - A version of browserfs that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["./api_error","./file_flag","../libs/path","./node_fs_stats","../generic/setImmediate"],function(t,n,e,r,o){"use strict";const{ApiError:i,ErrorCode:c}=t,{FileFlag:s}=n,{Stats:a}=r;let l=function(t,n){return t};function f(t,n){if("function"!=typeof t)throw new Error("Callback must be a function.");const e=l(t,n);switch(n){case 1:return function(t){o(function(){return e(t)})};case 2:return function(t,n){o(function(){return e(t,n)})};case 3:return function(t,n,r){o(function(){return e(t,n,r)})};default:throw new Error("Invalid invocation of wrapCb.")}}function h(t){if(t)return t;throw new i(c.EIO,"Initialize BrowserFS with a file system using BrowserFS.initialize(filesystem)")}function u(t,n){switch(typeof t){case"number":return t;case"string":const e=parseInt(t,8);return isNaN(e)?n:e;default:return n}}function d(t){if(t instanceof Date)return t;if("number"==typeof t)return new Date(1e3*t);throw new i(c.EINVAL,"Invalid time.")}function y(t){if(t.indexOf("\0")>=0)throw new i(c.EINVAL,"Path must be a string without null bytes.");if(""===t)throw new i(c.EINVAL,"Path must not be empty.");return e.resolve(t)}function w(t,n,e,r){switch(null===t?"null":typeof t){case"object":return{encoding:void 0!==t.encoding?t.encoding:n,flag:void 0!==t.flag?t.flag:e,mode:u(t.mode,r)};case"string":return{encoding:t,flag:e,mode:r};case"null":case"undefined":case"function":return{encoding:n,flag:e,mode:r};default:throw new TypeError(`"options" must be a string or an object, got ${typeof t} instead.`)}}function p(){}class m{constructor(){this.F_OK=0,this.R_OK=4,this.W_OK=2,this.X_OK=1,this.root=null,this.fdMap={},this.nextFd=100}initialize(t){if(!t.constructor.isAvailable())throw new i(c.EINVAL,"Tried to instantiate BrowserFS with an unavailable file system.");return this.root=t}_toUnixTimestamp(t){if("number"==typeof t)return t;if(t instanceof Date)return t.getTime()/1e3;throw new Error("Cannot parse time: "+t)}getRootFS(){return this.root?this.root:null}rename(t,n,e=p){const r=f(e,1);try{h(this.root).rename(y(t),y(n),r)}catch(t){r(t)}}renameSync(t,n){h(this.root).renameSync(y(t),y(n))}exists(t,n=p){const e=f(n,1);try{return h(this.root).exists(y(t),e)}catch(t){return e(!1)}}existsSync(t){try{return h(this.root).existsSync(y(t))}catch(t){return!1}}stat(t,n=p){const e=f(n,2);try{return h(this.root).stat(y(t),!1,e)}catch(t){return e(t)}}statSync(t){return h(this.root).statSync(y(t),!1)}lstat(t,n=p){const e=f(n,2);try{return h(this.root).stat(y(t),!0,e)}catch(t){return e(t)}}lstatSync(t){return h(this.root).statSync(y(t),!0)}truncate(t,n=0,e=p){let r=0;"function"==typeof n?e=n:"number"==typeof n&&(r=n);const o=f(e,1);try{if(r<0)throw new i(c.EINVAL);return h(this.root).truncate(y(t),r,o)}catch(t){return o(t)}}truncateSync(t,n=0){if(n<0)throw new i(c.EINVAL);return h(this.root).truncateSync(y(t),n)}unlink(t,n=p){const e=f(n,1);try{return h(this.root).unlink(y(t),e)}catch(t){return e(t)}}unlinkSync(t){return h(this.root).unlinkSync(y(t))}open(t,n,e,r=p){const o=u(e,420),i=f(r="function"==typeof e?e:r,2);try{h(this.root).open(y(t),s.getFileFlag(n),o,(t,n)=>{n?i(t,this.getFdForFile(n)):i(t)})}catch(t){i(t)}}openSync(t,n,e=420){return this.getFdForFile(h(this.root).openSync(y(t),s.getFileFlag(n),u(e,420)))}readFile(t,n={},e=p){const r=w(n,null,"r",null),o=f(e="function"==typeof n?n:e,2);try{const n=s.getFileFlag(r.flag);return n.isReadable()?h(this.root).readFile(y(t),r.encoding,n,o):o(new i(c.EINVAL,"Flag passed to readFile must allow for reading."))}catch(t){return o(t)}}readFileSync(t,n={}){const e=w(n,null,"r",null),r=s.getFileFlag(e.flag);if(!r.isReadable())throw new i(c.EINVAL,"Flag passed to readFile must allow for reading.");return h(this.root).readFileSync(y(t),e.encoding,r)}writeFile(t,n,e={},r=p){const o=w(e,"utf8","w",420),a=f(r="function"==typeof e?e:r,1);try{const e=s.getFileFlag(o.flag);return e.isWriteable()?h(this.root).writeFile(y(t),n,o.encoding,e,o.mode,a):a(new i(c.EINVAL,"Flag passed to writeFile must allow for writing."))}catch(t){return a(t)}}writeFileSync(t,n,e){const r=w(e,"utf8","w",420),o=s.getFileFlag(r.flag);if(!o.isWriteable())throw new i(c.EINVAL,"Flag passed to writeFile must allow for writing.");return h(this.root).writeFileSync(y(t),n,r.encoding,o,r.mode)}appendFile(t,n,e,r=p){const o=w(e,"utf8","a",420),a=f(r="function"==typeof e?e:r,1);try{const e=s.getFileFlag(o.flag);if(!e.isAppendable())return a(new i(c.EINVAL,"Flag passed to appendFile must allow for appending."));h(this.root).appendFile(y(t),n,o.encoding,e,o.mode,a)}catch(t){a(t)}}appendFileSync(t,n,e){const r=w(e,"utf8","a",420),o=s.getFileFlag(r.flag);if(!o.isAppendable())throw new i(c.EINVAL,"Flag passed to appendFile must allow for appending.");return h(this.root).appendFileSync(y(t),n,r.encoding,o,r.mode)}fstat(t,n=p){const e=f(n,2);try{this.fd2file(t).stat(e)}catch(t){e(t)}}fstatSync(t){return this.fd2file(t).statSync()}close(t,n=p){const e=f(n,1);try{this.fd2file(t).close(n=>{n||this.closeFd(t),e(n)})}catch(t){e(t)}}closeSync(t){this.fd2file(t).closeSync(),this.closeFd(t)}ftruncate(t,n,e=p){const r="number"==typeof n?n:0,o=f(e="function"==typeof n?n:e,1);try{const n=this.fd2file(t);if(r<0)throw new i(c.EINVAL);n.truncate(r,o)}catch(t){o(t)}}ftruncateSync(t,n=0){const e=this.fd2file(t);if(n<0)throw new i(c.EINVAL);e.truncateSync(n)}fsync(t,n=p){const e=f(n,1);try{this.fd2file(t).sync(e)}catch(t){e(t)}}fsyncSync(t){this.fd2file(t).syncSync()}fdatasync(t,n=p){const e=f(n,1);try{this.fd2file(t).datasync(e)}catch(t){e(t)}}fdatasyncSync(t){this.fd2file(t).datasyncSync()}write(t,n,e,r,o,s=p){let a,l,h,u=null;if("string"==typeof n){let t="utf8";switch(typeof e){case"function":s=e;break;case"number":u=e,t="string"==typeof r?r:"utf8",s="function"==typeof o?o:s;break;default:return(s="function"==typeof r?r:"function"==typeof o?o:s)(new i(c.EINVAL,"Invalid arguments."))}l=0,h=(a=Buffer.from(n,t)).length}else a=n,l=e,h=r,u="number"==typeof o?o:null,s="function"==typeof o?o:s;const d=f(s,3);try{const n=this.fd2file(t);void 0!==u&&null!==u||(u=n.getPos()),n.write(a,l,h,u,d)}catch(t){d(t)}}writeSync(t,n,e,r,o){let i,c,s,a=0;if("string"==typeof n){s="number"==typeof e?e:null;const t="string"==typeof r?r:"utf8";a=0,c=(i=Buffer.from(n,t)).length}else i=n,a=e,c=r,s="number"==typeof o?o:null;const l=this.fd2file(t);return void 0!==s&&null!==s||(s=l.getPos()),l.writeSync(i,a,c,s)}read(t,n,e,r,o,i=p){let c,s,a,l,h;if("number"==typeof n){a=n,c=e;const t=r;i="function"==typeof o?o:i,s=0,l=Buffer.alloc(a),h=f((n,e,r)=>{if(n)return i(n);i(n,r.toString(t),e)},3)}else l=n,s=e,a=r,c=o,h=f(i,3);try{const n=this.fd2file(t);void 0!==c&&null!==c||(c=n.getPos()),n.read(l,s,a,c,h)}catch(t){h(t)}}readSync(t,n,e,r,o){let i,c,s,a,l=!1,f="utf8";"number"==typeof n?(s=n,a=e,f=r,c=0,i=Buffer.alloc(s),l=!0):(i=n,c=e,s=r,a=o);const h=this.fd2file(t);void 0!==a&&null!==a||(a=h.getPos());const u=h.readSync(i,c,s,a);return l?[i.toString(f),u]:u}fchown(t,n,e,r=p){const o=f(r,1);try{this.fd2file(t).chown(n,e,o)}catch(t){o(t)}}fchownSync(t,n,e){this.fd2file(t).chownSync(n,e)}fchmod(t,n,e){const r=f(e,1);try{const e="string"==typeof n?parseInt(n,8):n;this.fd2file(t).chmod(e,r)}catch(t){r(t)}}fchmodSync(t,n){const e="string"==typeof n?parseInt(n,8):n;this.fd2file(t).chmodSync(e)}futimes(t,n,e,r=p){const o=f(r,1);try{const r=this.fd2file(t);"number"==typeof n&&(n=new Date(1e3*n)),"number"==typeof e&&(e=new Date(1e3*e)),r.utimes(n,e,o)}catch(t){o(t)}}futimesSync(t,n,e){this.fd2file(t).utimesSync(d(n),d(e))}rmdir(t,n=p){const e=f(n,1);try{t=y(t),h(this.root).rmdir(t,e)}catch(t){e(t)}}rmdirSync(t){return t=y(t),h(this.root).rmdirSync(t)}mkdir(t,n,e=p){"function"==typeof n&&(e=n,n=511);const r=f(e,1);try{t=y(t),h(this.root).mkdir(t,n,r)}catch(t){r(t)}}mkdirSync(t,n){h(this.root).mkdirSync(y(t),u(n,511))}readdir(t,n=p){const e=f(n,2);try{t=y(t),h(this.root).readdir(t,e)}catch(t){e(t)}}readdirSync(t){return t=y(t),h(this.root).readdirSync(t)}link(t,n,e=p){const r=f(e,1);try{t=y(t),n=y(n),h(this.root).link(t,n,r)}catch(t){r(t)}}linkSync(t,n){return t=y(t),n=y(n),h(this.root).linkSync(t,n)}symlink(t,n,e,r=p){const o="string"==typeof e?e:"file",s=f(r="function"==typeof e?e:r,1);try{if("file"!==o&&"dir"!==o)return s(new i(c.EINVAL,"Invalid type: "+o));t=y(t),n=y(n),h(this.root).symlink(t,n,o,s)}catch(t){s(t)}}symlinkSync(t,n,e){if(e){if("file"!==e&&"dir"!==e)throw new i(c.EINVAL,"Invalid type: "+e)}else e="file";return t=y(t),n=y(n),h(this.root).symlinkSync(t,n,e)}readlink(t,n=p){const e=f(n,2);try{t=y(t),h(this.root).readlink(t,e)}catch(t){e(t)}}readlinkSync(t){return t=y(t),h(this.root).readlinkSync(t)}chown(t,n,e,r=p){const o=f(r,1);try{t=y(t),h(this.root).chown(t,!1,n,e,o)}catch(t){o(t)}}chownSync(t,n,e){t=y(t),h(this.root).chownSync(t,!1,n,e)}lchown(t,n,e,r=p){const o=f(r,1);try{t=y(t),h(this.root).chown(t,!0,n,e,o)}catch(t){o(t)}}lchownSync(t,n,e){t=y(t),h(this.root).chownSync(t,!0,n,e)}chmod(t,n,e=p){const r=f(e,1);try{const e=u(n,-1);if(e<0)throw new i(c.EINVAL,"Invalid mode.");h(this.root).chmod(y(t),!1,e,r)}catch(t){r(t)}}chmodSync(t,n){const e=u(n,-1);if(e<0)throw new i(c.EINVAL,"Invalid mode.");t=y(t),h(this.root).chmodSync(t,!1,e)}lchmod(t,n,e=p){const r=f(e,1);try{const e=u(n,-1);if(e<0)throw new i(c.EINVAL,"Invalid mode.");h(this.root).chmod(y(t),!0,e,r)}catch(t){r(t)}}lchmodSync(t,n){const e=u(n,-1);if(e<1)throw new i(c.EINVAL,"Invalid mode.");h(this.root).chmodSync(y(t),!0,e)}utimes(t,n,e,r=p){const o=f(r,1);try{h(this.root).utimes(y(t),d(n),d(e),o)}catch(t){o(t)}}utimesSync(t,n,e){h(this.root).utimesSync(y(t),d(n),d(e))}realpath(t,n,e=p){const r="object"==typeof n?n:{},o=f("function"==typeof n?n:p,2);try{t=y(t),h(this.root).realpath(t,r,o)}catch(t){o(t)}}realpathSync(t,n={}){return t=y(t),h(this.root).realpathSync(t,n)}watchFile(t,n,e=p){throw new i(c.ENOTSUP)}unwatchFile(t,n=p){throw new i(c.ENOTSUP)}watch(t,n,e=p){throw new i(c.ENOTSUP)}access(t,n,e=p){throw new i(c.ENOTSUP)}accessSync(t,n){throw new i(c.ENOTSUP)}createReadStream(t,n){throw new i(c.ENOTSUP)}createWriteStream(t,n){throw new i(c.ENOTSUP)}wrapCallbacks(t){l=t}getFdForFile(t){const n=this.nextFd++;return this.fdMap[n]=t,n}fd2file(t){const n=this.fdMap[t];if(n)return n;throw new i(c.EBADF,"Invalid file descriptor.")}closeFd(t){delete this.fdMap[t]}}return m.Stats=a,m});
//# sourceMappingURL=../sourcemaps/core/FS.js.map
