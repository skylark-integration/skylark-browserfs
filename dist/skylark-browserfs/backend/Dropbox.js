/**
 * skylark-browserfs - A version of browserfs that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../libs/buffers","../generic/preload_file","../core/file_system","../core/node_fs_stats","../core/api_error","../core/util","../generic/setImmediate","../libs/path"],function(e,t,r,s,a,n,o,i){"use strict";const{BaseFileSystem:c}=r,{Stats:l,FileType:h}=s,{ApiError:u,ErrorCode:f}=a,{arrayBuffer2Buffer:p,buffer2ArrayBuffer:_}=n,{dirname:d}=i,{PreloadFile:m}=t,{Buffer:w}=e;function E(e){return"/"===e?"":e}function y(e){const t=e.error;if(t[".tag"])return t;if(t.error){const e=t.error;return e[".tag"]?e:e.reason&&e.reason[".tag"]?e.reason:e}if("string"==typeof t)try{const r=JSON.parse(t);if(r.error&&r.error.reason&&r.error.reason[".tag"])return r.error.reason}catch(e){}return t}function b(e){if(e.user_message)return e.user_message.text;if(e.error_summary)return e.error_summary;if("string"==typeof e.error)return e.error;if("object"==typeof e.error)return b(e.error);throw new Error(`Dropbox's servers gave us a garbage error message: ${JSON.stringify(e)}`)}function g(e,t,r){switch(e[".tag"]){case"malformed_path":return new u(f.EBADF,r,t);case"not_found":return u.ENOENT(t);case"not_file":return u.EISDIR(t);case"not_folder":return u.ENOTDIR(t);case"restricted_content":return u.EPERM(t);case"other":default:return new u(f.EIO,r,t)}}function k(e,t,r){switch(e[".tag"]){case"malformed_path":case"disallowed_name":return new u(f.EBADF,r,t);case"conflict":case"no_write_permission":case"team_folder":return u.EPERM(t);case"insufficient_space":return new u(f.ENOSPC,r);case"other":default:return new u(f.EIO,r,t)}}function I(e,t,r){const s={path:E(t)};e.filesDeleteV2(s).then(()=>{r()}).catch(s=>{const a=y(s);switch(a[".tag"]){case"path_lookup":r(g(a.path_lookup,t,b(s)));break;case"path_write":r(k(a.path_write,t,b(s)));break;case"too_many_write_operations":setTimeout(()=>I(e,t,r),500+300*Math.random());break;case"other":default:r(new u(f.EIO,b(s),t))}})}class O extends m{constructor(e,t,r,s,a){super(e,t,r,s,a)}sync(e){this._fs._syncFile(this.getPath(),this.getBuffer(),e)}close(e){this.sync(e)}}class D extends c{constructor(e){super(),this._client=e}static Create(e,t){t(null,new D(e.client))}static isAvailable(){return"undefined"!=typeof Dropbox}getName(){return D.Name}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(e){this.readdir("/",(t,r)=>{if(r){const t=s=>{0===r.length?e():I(this._client,r.shift(),t)};t()}else e(t)})}rename(e,t,r){this.stat(t,!1,(s,a)=>{const n=()=>{const s={from_path:E(e),to_path:E(t)};this._client.filesMoveV2(s).then(()=>r()).catch(function(s){const a=y(s);switch(a[".tag"]){case"from_lookup":r(g(a.from_lookup,e,b(s)));break;case"from_write":r(k(a.from_write,e,b(s)));break;case"to":r(k(a.to,t,b(s)));break;case"cant_copy_shared_folder":case"cant_nest_shared_folder":r(new u(f.EPERM,b(s),e));break;case"cant_move_folder_into_itself":case"duplicated_or_nested_paths":r(new u(f.EBADF,b(s),e));break;case"too_many_files":r(new u(f.ENOSPC,b(s),e));break;case"other":default:r(new u(f.EIO,b(s),e))}})};s?n():e===t?s?r(u.ENOENT(t)):r():a&&a.isDirectory()?r(u.EISDIR(t)):this.unlink(t,e=>{e?r(e):n()})})}stat(e,t,r){if("/"===e)return void o(function(){r(null,new l(h.DIRECTORY,4096))});const s={path:E(e)};this._client.filesGetMetadata(s).then(t=>{switch(t[".tag"]){case"file":const s=t;r(null,new l(h.FILE,s.size));break;case"folder":r(null,new l(h.DIRECTORY,4096));break;case"deleted":r(u.ENOENT(e))}}).catch(t=>{const s=y(t);switch(s[".tag"]){case"path":r(g(s.path,e,b(t)));break;default:r(new u(f.EIO,b(t),e))}})}openFile(e,t,r){const s={path:E(e)};this._client.filesDownload(s).then(s=>{const a=s.fileBlob,n=new FileReader;n.onload=(()=>{const s=n.result;r(null,new O(this,e,t,new l(h.FILE,s.byteLength),p(s)))}),n.readAsArrayBuffer(a)}).catch(t=>{const s=y(t);switch(s[".tag"]){case"path":r(g(s.path,e,b(t)));break;case"other":default:r(new u(f.EIO,b(t),e))}})}createFile(e,t,r,s){const a=w.alloc(0),n={contents:new Blob([_(a)],{type:"octet/stream"}),path:E(e)};this._client.filesUpload(n).then(r=>{s(null,new O(this,e,t,new l(h.FILE,0),a))}).catch(a=>{const n=y(a);switch(n[".tag"]){case"path":s(k(n.path.reason,e,b(a)));break;case"too_many_write_operations":setTimeout(()=>this.createFile(e,t,r,s),500+300*Math.random());break;case"other":default:s(new u(f.EIO,b(a),e))}})}unlink(e,t){this.stat(e,!1,(r,s)=>{s?s.isDirectory()?t(u.EISDIR(e)):I(this._client,e,t):t(r)})}rmdir(e,t){this.readdir(e,(r,s)=>{s?s.length>0?t(u.ENOTEMPTY(e)):I(this._client,e,t):t(r)})}mkdir(e,t,r){const s=d(e);this.stat(s,!1,(a,n)=>{if(a)r(a);else if(n&&!n.isDirectory())r(u.ENOTDIR(s));else{const s={path:E(e)};this._client.filesCreateFolderV2(s).then(()=>r()).catch(s=>{"too_many_write_operations"===y(s)[".tag"]?setTimeout(()=>this.mkdir(e,t,r),500+300*Math.random()):r(k(y(s).path,e,b(s)))})}})}readdir(e,t){const r={path:E(e)};this._client.filesListFolder(r).then(r=>{!function e(t,r,s,a,n){const o=s.entries.map(e=>e.path_display).filter(e=>!!e);const i=a.concat(o);if(s.has_more){const a={cursor:s.cursor};t.filesListFolderContinue(a).then(s=>{e(t,r,s,i,n)}).catch(e=>{F(e,r,n)})}else n(null,i)}(this._client,e,r,[],t)}).catch(r=>{F(r,e,t)})}_syncFile(e,t,r){const s={contents:new Blob([_(t)],{type:"octet/stream"}),path:E(e),mode:{".tag":"overwrite"}};this._client.filesUpload(s).then(()=>{r()}).catch(s=>{const a=y(s);switch(a[".tag"]){case"path":r(k(a.path.reason,e,b(s)));break;case"too_many_write_operations":setTimeout(()=>this._syncFile(e,t,r),500+300*Math.random());break;case"other":default:r(new u(f.EIO,b(s),e))}})}}function F(e,t,r){const s=y(e);switch(s[".tag"]){case"path":r(g(s.path,t,b(e)));break;case"other":default:r(new u(f.EIO,b(e),t))}}return D.Name="DropboxV2",D.Options={client:{type:"object",description:"An *authenticated* Dropbox client. Must be from the 2.5.x JS SDK."}},D.DropboxFile=O,D});
//# sourceMappingURL=../sourcemaps/backend/Dropbox.js.map
