/**
 * skylark-browserfs - A version of browserfs that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../core/api_error","../core/node_fs_stats","../core/file_system","../core/file_flag","../generic/preload_file","../core/util","../generic/extended_ascii","../generic/setImmediate","../generic/file_index"],function(t,e,i,r,n,a,s,d,o){"use strict";const{ApiError:h,ErrorCode:c}=t,{Stats:l,FileType:u}=e,{SynchronousFileSystem:E}=i,{ActionType:f}=r,{NoSyncFile:I}=n,{arrayish2Buffer:L,copyingSlice:m,bufferValidator:g}=a;let p;try{p=require("pako/lib/inflate").inflateRaw}catch(t){console.warn(t)}const{FileIndex:S,DirInode:D,FileInode:_,isDirInode:N,isFileInode:U}="../generic/file_index",w={};var T,F;function A(t,e){return new Date(1980+(e>>9),(e>>5&15)-1,31&e,t>>11,t>>5&63,31&t)}function y(t,e,i,r){return 0===r?"":e?t.toString("utf8",i,i+r):s.byte2str(t.slice(i,i+r))}!function(t){t[t.MSDOS=0]="MSDOS",t[t.AMIGA=1]="AMIGA",t[t.OPENVMS=2]="OPENVMS",t[t.UNIX=3]="UNIX",t[t.VM_CMS=4]="VM_CMS",t[t.ATARI_ST=5]="ATARI_ST",t[t.OS2_HPFS=6]="OS2_HPFS",t[t.MAC=7]="MAC",t[t.Z_SYSTEM=8]="Z_SYSTEM",t[t.CP_M=9]="CP_M",t[t.NTFS=10]="NTFS",t[t.MVS=11]="MVS",t[t.VSE=12]="VSE",t[t.ACORN_RISC=13]="ACORN_RISC",t[t.VFAT=14]="VFAT",t[t.ALT_MVS=15]="ALT_MVS",t[t.BEOS=16]="BEOS",t[t.TANDEM=17]="TANDEM",t[t.OS_400=18]="OS_400",t[t.OSX=19]="OSX"}(T||(T={})),function(t){t[t.STORED=0]="STORED",t[t.SHRUNK=1]="SHRUNK",t[t.REDUCED_1=2]="REDUCED_1",t[t.REDUCED_2=3]="REDUCED_2",t[t.REDUCED_3=4]="REDUCED_3",t[t.REDUCED_4=5]="REDUCED_4",t[t.IMPLODE=6]="IMPLODE",t[t.DEFLATE=8]="DEFLATE",t[t.DEFLATE64=9]="DEFLATE64",t[t.TERSE_OLD=10]="TERSE_OLD",t[t.BZIP2=12]="BZIP2",t[t.LZMA=14]="LZMA",t[t.TERSE_NEW=18]="TERSE_NEW",t[t.LZ77=19]="LZ77",t[t.WAVPACK=97]="WAVPACK",t[t.PPMD=98]="PPMD"}(F||(F={}));class C{constructor(t){if(this.data=t,67324752!==t.readUInt32LE(0))throw new h(c.EINVAL,"Invalid Zip file: Local file header has invalid signature: "+this.data.readUInt32LE(0))}versionNeeded(){return this.data.readUInt16LE(4)}flags(){return this.data.readUInt16LE(6)}compressionMethod(){return this.data.readUInt16LE(8)}lastModFileTime(){return A(this.data.readUInt16LE(10),this.data.readUInt16LE(12))}rawLastModFileTime(){return this.data.readUInt32LE(10)}crc32(){return this.data.readUInt32LE(14)}fileNameLength(){return this.data.readUInt16LE(26)}extraFieldLength(){return this.data.readUInt16LE(28)}fileName(){return y(this.data,this.useUTF8(),30,this.fileNameLength())}extraField(){const t=30+this.fileNameLength();return this.data.slice(t,t+this.extraFieldLength())}totalSize(){return 30+this.fileNameLength()+this.extraFieldLength()}useUTF8(){return 2048==(2048&this.flags())}}class R{constructor(t,e,i){this.header=t,this.record=e,this.data=i}decompress(){const t=this.header.compressionMethod(),e=w[t];if(e)return e(this.data,this.record.compressedSize(),this.record.uncompressedSize(),this.record.flag());{let e=F[t];throw e||(e=`Unknown: ${t}`),new h(c.EINVAL,`Invalid compression method on file '${this.header.fileName()}': ${e}`)}}getHeader(){return this.header}getRecord(){return this.record}getRawData(){return this.data}}class M{constructor(t,e){if(this.zipData=t,this.data=e,33639248!==this.data.readUInt32LE(0))throw new h(c.EINVAL,`Invalid Zip file: Central directory record has invalid signature: ${this.data.readUInt32LE(0)}`);this._filename=this.produceFilename()}versionMadeBy(){return this.data.readUInt16LE(4)}versionNeeded(){return this.data.readUInt16LE(6)}flag(){return this.data.readUInt16LE(8)}compressionMethod(){return this.data.readUInt16LE(10)}lastModFileTime(){return A(this.data.readUInt16LE(12),this.data.readUInt16LE(14))}rawLastModFileTime(){return this.data.readUInt32LE(12)}crc32(){return this.data.readUInt32LE(16)}compressedSize(){return this.data.readUInt32LE(20)}uncompressedSize(){return this.data.readUInt32LE(24)}fileNameLength(){return this.data.readUInt16LE(28)}extraFieldLength(){return this.data.readUInt16LE(30)}fileCommentLength(){return this.data.readUInt16LE(32)}diskNumberStart(){return this.data.readUInt16LE(34)}internalAttributes(){return this.data.readUInt16LE(36)}externalAttributes(){return this.data.readUInt32LE(38)}headerRelativeOffset(){return this.data.readUInt32LE(42)}produceFilename(){return y(this.data,this.useUTF8(),46,this.fileNameLength()).replace(/\\/g,"/")}fileName(){return this._filename}rawFileName(){return this.data.slice(46,46+this.fileNameLength())}extraField(){const t=44+this.fileNameLength();return this.data.slice(t,t+this.extraFieldLength())}fileComment(){const t=46+this.fileNameLength()+this.extraFieldLength();return y(this.data,this.useUTF8(),t,this.fileCommentLength())}rawFileComment(){const t=46+this.fileNameLength()+this.extraFieldLength();return this.data.slice(t,t+this.fileCommentLength())}totalSize(){return 46+this.fileNameLength()+this.extraFieldLength()+this.fileCommentLength()}isDirectory(){const t=this.fileName();return!!(16&this.externalAttributes())||"/"===t.charAt(t.length-1)}isFile(){return!this.isDirectory()}useUTF8(){return 2048==(2048&this.flag())}isEncrypted(){return 1==(1&this.flag())}getFileData(){const t=this.headerRelativeOffset(),e=new C(this.zipData.slice(t));return new R(e,this,this.zipData.slice(t+e.totalSize()))}getData(){return this.getFileData().decompress()}getRawData(){return this.getFileData().getRawData()}getStats(){return new l(u.FILE,this.uncompressedSize(),365,Date.now(),this.lastModFileTime().getTime())}}class O{constructor(t){if(this.data=t,101010256!==this.data.readUInt32LE(0))throw new h(c.EINVAL,`Invalid Zip file: End of central directory record has invalid signature: ${this.data.readUInt32LE(0)}`)}diskNumber(){return this.data.readUInt16LE(4)}cdDiskNumber(){return this.data.readUInt16LE(6)}cdDiskEntryCount(){return this.data.readUInt16LE(8)}cdTotalEntryCount(){return this.data.readUInt16LE(10)}cdSize(){return this.data.readUInt32LE(12)}cdOffset(){return this.data.readUInt32LE(16)}cdZipCommentLength(){return this.data.readUInt16LE(20)}cdZipComment(){return y(this.data,!0,22,this.cdZipCommentLength())}rawCdZipComment(){return this.data.slice(22,22+this.cdZipCommentLength())}}class x{constructor(t,e,i,r){this.index=t,this.directoryEntries=e,this.eocd=i,this.data=r}}class P extends E{constructor(t,e=""){super(),this.name=e,this._index=new S,this._directoryEntries=[],this._eocd=null,this._index=t.index,this._directoryEntries=t.directoryEntries,this._eocd=t.eocd,this.data=t.data}static Create(t,e){try{P._computeIndex(t.zipData,(i,r)=>{if(r){const i=new P(r,t.name);e(null,i)}else e(i)})}catch(t){e(t)}}static isAvailable(){return!0}static RegisterDecompressionMethod(t,e){w[t]=e}static _getEOCD(t){const e=Math.min(65557,t.length-1);for(let i=22;i<e;i++)if(101010256===t.readUInt32LE(t.length-i))return new O(t.slice(t.length-i));throw new h(c.EINVAL,"Invalid ZIP file: Could not locate End of Central Directory signature.")}static _addToIndex(t,e){let i=t.fileName();if("/"===i.charAt(0))throw new h(c.EPERM,"Unexpectedly encountered an absolute path in a zip file. Please file a bug.");"/"===i.charAt(i.length-1)&&(i=i.substr(0,i.length-1)),t.isDirectory()?e.addPathFast("/"+i,new D(t)):e.addPathFast("/"+i,new _(t))}static _computeIndex(t,e){try{const i=new S,r=P._getEOCD(t);if(r.diskNumber()!==r.cdDiskNumber())return e(new h(c.EINVAL,"ZipFS does not support spanned zip files."));const n=r.cdOffset();if(4294967295===n)return e(new h(c.EINVAL,"ZipFS does not support Zip64."));const a=n+r.cdSize();P._computeIndexResponsive(t,i,n,a,e,[],r)}catch(t){e(t)}}static _computeIndexResponsiveTrampoline(t,e,i,r,n,a,s){try{P._computeIndexResponsive(t,e,i,r,n,a,s)}catch(t){n(t)}}static _computeIndexResponsive(t,e,i,r,n,a,s){if(i<r){let o=0;for(;o++<200&&i<r;){const r=new M(t,t.slice(i));P._addToIndex(r,e),i+=r.totalSize(),a.push(r)}d(()=>{P._computeIndexResponsiveTrampoline(t,e,i,r,n,a,s)})}else n(null,new x(e,a,s,t))}getName(){return P.Name+(""!==this.name?` ${this.name}`:"")}getCentralDirectoryEntry(t){const e=this._index.getInode(t);if(null===e)throw h.ENOENT(t);if(U(e))return e.getData();if(N(e))return e.getData();throw h.EPERM(`Invalid inode: ${e}`)}getCentralDirectoryEntryAt(t){const e=this._directoryEntries[t];if(!e)throw new RangeError(`Invalid directory index: ${t}.`);return e}getNumberOfCentralDirectoryEntries(){return this._directoryEntries.length}getEndOfCentralDirectory(){return this._eocd}diskSpace(t,e){e(this.data.length,0)}isReadOnly(){return!0}supportsLinks(){return!1}supportsProps(){return!1}supportsSynch(){return!0}statSync(t,e){const i=this._index.getInode(t);if(null===i)throw h.ENOENT(t);let r;if(U(i))r=i.getData().getStats();else{if(!N(i))throw new h(c.EINVAL,"Invalid inode.");r=i.getStats()}return r}openSync(t,e,i){if(e.isWriteable())throw new h(c.EPERM,t);const r=this._index.getInode(t);if(!r)throw h.ENOENT(t);if(!U(r))throw h.EISDIR(t);{const i=r.getData(),n=i.getStats();switch(e.pathExistsAction()){case f.THROW_EXCEPTION:case f.TRUNCATE_FILE:throw h.EEXIST(t);case f.NOP:return new I(this,t,e,n,i.getData());default:throw new h(c.EINVAL,"Invalid FileMode object.")}}}readdirSync(t){const e=this._index.getInode(t);if(e){if(N(e))return e.getListing();throw h.ENOTDIR(t)}throw h.ENOENT(t)}readFileSync(t,e,i){const r=this.openSync(t,i,420);try{const t=r.getBuffer();return null===e?m(t):t.toString(e)}finally{r.closeSync()}}}return P.Name="ZipFS",P.Options={zipData:{type:"object",description:"The zip file as a Buffer object.",validator:g},name:{type:"string",optional:!0,description:"The name of the zip file (optional)."}},P.CompressionMethod=F,P.RegisterDecompressionMethod(F.DEFLATE,(t,e,i)=>L(p(t.slice(0,e),{chunkSize:i}))),P.RegisterDecompressionMethod(F.STORED,(t,e,i)=>m(t,0,i)),P});
//# sourceMappingURL=../sourcemaps/backend/ZipFS.js.map
