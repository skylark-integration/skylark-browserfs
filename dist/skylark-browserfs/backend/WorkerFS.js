/**
 * skylark-browserfs - A version of browserfs that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../core/file_system","../core/api_error","../core/file_flag","../core/util","../core/file","../core/node_fs_stats","../generic/preload_file","../core/global","../core/node_fs"],function(e,t,s,r,n,o,a,i,c){"use strict";const{BaseFileSystem:l}=e,{ApiError:u,ErrorCode:p}=t,{FileFlag:f}=s,{buffer2ArrayBuffer:h,arrayBuffer2Buffer:d,emptyBuffer:g}=r,{BaseFile:_}=n,{Stats:R}=o,{PreloadFile:m}=a;var y;!function(e){e[e.CB=0]="CB",e[e.FD=1]="FD",e[e.API_ERROR=2]="API_ERROR",e[e.STATS=3]="STATS",e[e.PROBE=4]="PROBE",e[e.FILEFLAG=5]="FILEFLAG",e[e.BUFFER=6]="BUFFER",e[e.ERROR=7]="ERROR"}(y||(y={}));class F{constructor(){this._callbacks={},this._nextId=0}toRemoteArg(e){const t=this._nextId++;return this._callbacks[t]=e,{type:y.CB,id:t}}toLocalArg(e){const t=this._callbacks[e];return delete this._callbacks[e],t}}class b{constructor(){this._fileDescriptors={},this._nextId=0}toRemoteArg(e,t,s,r){const n=this._nextId++;let o,a;this._fileDescriptors[n]=e,e.stat((i,c)=>{i?r(i):(a=O(c.toBuffer()),s.isReadable()?e.read(Buffer.alloc(c.size),0,c.size,0,(e,i,c)=>{e?r(e):(o=O(c),r(null,{type:y.FD,id:n,data:o,stat:a,path:t,flag:s.getFlagString()}))}):r(null,{type:y.FD,id:n,data:new ArrayBuffer(0),stat:a,path:t,flag:s.getFlagString()}))})}applyFdAPIRequest(e,t){const s=e.args[0];this._applyFdChanges(s,(r,n)=>{r?t(r):n[e.method](r=>{"close"===e.method&&delete this._fileDescriptors[s.id],t(r)})})}_applyFdChanges(e,t){const s=this._fileDescriptors[e.id],r=P(e.data),n=R.fromBuffer(P(e.stat)),o=f.getFileFlag(e.flag);o.isWriteable()?s.write(r,0,r.length,o.isAppendable()?s.getPos():0,e=>{function a(){s.stat((e,r)=>{e?t(e):r.mode!==n.mode?s.chmod(n.mode,e=>{t(e,s)}):t(e,s)})}e?t(e):o.isAppendable()?a():s.truncate(r.length,()=>{a()})}):t(null,s)}}function w(e){return{type:y.API_ERROR,errorData:O(e.writeToBuffer())}}function k(e){return u.fromBuffer(P(e.errorData))}function A(e){return{type:y.ERROR,name:e.name,message:e.message,stack:e.stack}}function B(e){let t=i[e.name];"function"!=typeof t&&(t=Error);const s=new t(e.message);return s.stack=e.stack,s}function E(e){return{type:y.STATS,statsData:O(e.toBuffer())}}function I(e){return R.fromBuffer(P(e.statsData))}function L(e){return{type:y.FILEFLAG,flagStr:e.getFlagString()}}function S(e){return f.getFileFlag(e.flagStr)}function O(e){return h(e)}function P(e){return d(e)}function M(e){return{type:y.BUFFER,data:O(e)}}function C(e){return P(e.data)}class D extends m{constructor(e,t,s,r,n,o){super(e,t,s,r,o),this._remoteFdId=n}getRemoteFdId(){return this._remoteFdId}toRemoteArg(){return{type:y.FD,id:this._remoteFdId,data:O(this.getBuffer()),stat:O(this.getStats().toBuffer()),path:this.getPath(),flag:this.getFlag().getFlagString()}}sync(e){this._syncClose("sync",e)}close(e){this._syncClose("close",e)}_syncClose(e,t){this.isDirty()?this._fs.syncClose(e,this,e=>{e||this.resetDirty(),t(e)}):t()}}class v extends l{constructor(e){var t;super(),this._callbackConverter=new F,this._isInitialized=!1,this._isReadOnly=!1,this._supportLinks=!1,this._supportProps=!1,this._worker=e,this._worker.addEventListener("message",e=>{const s=e.data;if((t=s)&&"object"==typeof t&&t.hasOwnProperty("browserfsMessage")&&t.browserfsMessage){let e;const t=s.args,r=new Array(t.length);for(e=0;e<r.length;e++)r[e]=this._argRemote2Local(t[e]);this._callbackConverter.toLocalArg(s.cbId).apply(null,r)}})}static Create(e,t){const s=new v(e.worker);s._initialize(()=>{t(null,s)})}static isAvailable(){return"undefined"!=typeof importScripts||"undefined"!=typeof Worker}static attachRemoteListener(e){const t=new b;function s(e,s,r){switch(typeof e){case"object":e instanceof R?r(null,E(e)):e instanceof u?r(null,w(e)):e instanceof _?r(null,t.toRemoteArg(e,s[0],s[1],r)):e instanceof f?r(null,L(e)):e instanceof Buffer?r(null,M(e)):e instanceof Error?r(null,A(e)):r(null,e);break;default:r(null,e)}}function r(t,r){if(!t)return t;switch(typeof t){case"object":if("number"!=typeof t.type)return t;{const n=t;switch(n.type){case y.CB:const o=t.id;return function(){let t;const n=new Array(arguments.length);let a,i=arguments.length;for(t=0;t<arguments.length;t++)((t,c)=>{s(c,r,(s,r)=>{n[t]=r,s?i>0&&(i=-1,a={browserfsMessage:!0,cbId:o,args:[w(s)]},e.postMessage(a)):0==--i&&(a={browserfsMessage:!0,cbId:o,args:n},e.postMessage(a))})})(t,arguments[t]);0===arguments.length&&(a={browserfsMessage:!0,cbId:o,args:n},e.postMessage(a))};case y.API_ERROR:return k(n);case y.STATS:return I(n);case y.FILEFLAG:return S(n);case y.BUFFER:return C(n);case y.ERROR:return B(n);default:return t}}default:return t}}var n;e.addEventListener("message",s=>{const o=s.data;if((n=o)&&"object"==typeof n&&n.hasOwnProperty("browserfsMessage")&&n.browserfsMessage){const s=o.args,n=new Array(s.length);switch(o.method){case"close":case"sync":(()=>{const r=s[1];t.applyFdAPIRequest(o,t=>{const s={browserfsMessage:!0,cbId:r.id,args:t?[w(t)]:[]};e.postMessage(s)})})();break;case"probe":(()=>{const t=c.getRootFS(),r=s[1],n={type:y.PROBE,isReadOnly:t.isReadOnly(),supportsLinks:t.supportsLinks(),supportsProps:t.supportsProps()},o={browserfsMessage:!0,cbId:r.id,args:[n]};e.postMessage(o)})();break;default:for(let e=0;e<s.length;e++)n[e]=r(s[e],n);const a=c.getRootFS();a[o.method].apply(a,n)}}})}getName(){return v.Name}isReadOnly(){return this._isReadOnly}supportsSynch(){return!1}supportsLinks(){return this._supportLinks}supportsProps(){return this._supportProps}rename(e,t,s){this._rpc("rename",arguments)}stat(e,t,s){this._rpc("stat",arguments)}open(e,t,s,r){this._rpc("open",arguments)}unlink(e,t){this._rpc("unlink",arguments)}rmdir(e,t){this._rpc("rmdir",arguments)}mkdir(e,t,s){this._rpc("mkdir",arguments)}readdir(e,t){this._rpc("readdir",arguments)}exists(e,t){this._rpc("exists",arguments)}realpath(e,t,s){this._rpc("realpath",arguments)}truncate(e,t,s){this._rpc("truncate",arguments)}readFile(e,t,s,r){this._rpc("readFile",arguments)}writeFile(e,t,s,r,n,o){this._rpc("writeFile",arguments)}appendFile(e,t,s,r,n,o){this._rpc("appendFile",arguments)}chmod(e,t,s,r){this._rpc("chmod",arguments)}chown(e,t,s,r,n){this._rpc("chown",arguments)}utimes(e,t,s,r){this._rpc("utimes",arguments)}link(e,t,s){this._rpc("link",arguments)}symlink(e,t,s,r){this._rpc("symlink",arguments)}readlink(e,t){this._rpc("readlink",arguments)}syncClose(e,t,s){this._worker.postMessage({browserfsMessage:!0,method:e,args:[t.toRemoteArg(),this._callbackConverter.toRemoteArg(s)]})}_initialize(e){if(this._isInitialized)e();else{const t={browserfsMessage:!0,method:"probe",args:[this._argLocal2Remote(g()),this._callbackConverter.toRemoteArg(t=>{this._isInitialized=!0,this._isReadOnly=t.isReadOnly,this._supportLinks=t.supportsLinks,this._supportProps=t.supportsProps,e()})]};this._worker.postMessage(t)}}_argRemote2Local(e){if(!e)return e;switch(typeof e){case"object":if("number"!=typeof e.type)return e;{const t=e;switch(t.type){case y.API_ERROR:return k(t);case y.FD:const s=t;return new D(this,s.path,f.getFileFlag(s.flag),R.fromBuffer(P(s.stat)),s.id,P(s.data));case y.STATS:return I(t);case y.FILEFLAG:return S(t);case y.BUFFER:return C(t);case y.ERROR:return B(t);default:return e}}default:return e}}_rpc(e,t){const s=new Array(t.length);for(let e=0;e<t.length;e++)s[e]=this._argLocal2Remote(t[e]);const r={browserfsMessage:!0,method:e,args:s};this._worker.postMessage(r)}_argLocal2Remote(e){if(!e)return e;switch(typeof e){case"object":return e instanceof R?E(e):e instanceof u?w(e):e instanceof D?e.toRemoteArg():e instanceof f?L(e):e instanceof Buffer?M(e):e instanceof Error?A(e):"Unknown argument";case"function":return this._callbackConverter.toRemoteArg(e);default:return e}}}return v.Name="WorkerFS",v.Options={worker:{type:"object",description:"The target worker that you want to connect to, or the current worker if in a worker context.",validator:function(e,t){e.postMessage?t():t(new u(p.EINVAL,"option must be a Web Worker instance."))}}},v});
//# sourceMappingURL=../sourcemaps/backend/WorkerFS.js.map
