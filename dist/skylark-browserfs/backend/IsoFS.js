/**
 * skylark-browserfs - A version of browserfs that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../core/api_error","../core/node_fs_stats","../core/file_system","../core/file_flag","../generic/preload_file","../core/util","../libs/path"],function(t,e,r,s,i,n,a){"use strict";const{ApiError:o,ErrorCode:c}=t,{Stats:h,FileType:u}=e,{SynchronousFileSystem:l}=r,{ActionType:d}=s,{NoSyncFile:f}=i,{copyingSlice:g,bufferValidator:_}=n,p="IEEE_P1282";function S(t,e,r){return t.toString("ascii",e,e+r).trim()}function y(t,e,r){if(1===r)return String.fromCharCode(t[e]);const s=Math.floor(r/2),i=new Array(s);for(let r=0;r<s;r++){const s=e+(r<<1);i[r]=String.fromCharCode(t[s+1]|t[s]<<8)}return i.join("")}function E(t,e){const r=parseInt(S(t,e,4),10),s=parseInt(S(t,e+4,2),10),i=parseInt(S(t,e+6,2),10),n=parseInt(S(t,e+8,2),10),a=parseInt(S(t,e+10,2),10),o=parseInt(S(t,e+12,2),10),c=parseInt(S(t,e+14,2),10);return new Date(r,s,i,n,a,o,100*c)}function R(t,e){const r=t[e],s=t[e+1],i=t[e+2],n=t[e+3],a=t[e+4],o=t[e+5];return new Date(r,s-1,i,n,a,o)}function m(t,e){const r=t.slice(e),s=new v(r);switch(s.signatureWord()){case 17221:return new x(r);case 20548:return new F(r);case 21328:return new T(r);case 21332:return new N(r);case 17746:return new P(r);case 17747:return new C(r);case 20568:return new z(r);case 20558:return new M(r);case 21324:return new B(r);case 20045:return new V(r);case 17228:return new G(r);case 20556:return new W(r);case 21061:return new $(r);case 21574:return new j(r);case 21318:return new H(r);case 21074:return new A(r);default:return s}}function I(t,e,r,s){r-=4;let i=new Array;for(;e<r;){const r=m(t,e),n=r.length();if(0===n)return i;if(e+=n,r instanceof N)break;r instanceof x?i=i.concat(r.getEntries(s)):i.push(r)}return i}class L{constructor(t){this._data=t}type(){return this._data[0]}standardIdentifier(){return S(this._data,1,5)}version(){return this._data[6]}data(){return this._data.slice(7,2048)}}class D extends L{constructor(t){super(t),this._root=null}systemIdentifier(){return this._getString32(8)}volumeIdentifier(){return this._getString32(40)}volumeSpaceSize(){return this._data.readUInt32LE(80)}volumeSetSize(){return this._data.readUInt16LE(120)}volumeSequenceNumber(){return this._data.readUInt16LE(124)}logicalBlockSize(){return this._data.readUInt16LE(128)}pathTableSize(){return this._data.readUInt32LE(132)}locationOfTypeLPathTable(){return this._data.readUInt32LE(140)}locationOfOptionalTypeLPathTable(){return this._data.readUInt32LE(144)}locationOfTypeMPathTable(){return this._data.readUInt32BE(148)}locationOfOptionalTypeMPathTable(){return this._data.readUInt32BE(152)}rootDirectoryEntry(t){return null===this._root&&(this._root=this._constructRootDirectoryRecord(this._data.slice(156)),this._root.rootCheckForRockRidge(t)),this._root}volumeSetIdentifier(){return this._getString(190,128)}publisherIdentifier(){return this._getString(318,128)}dataPreparerIdentifier(){return this._getString(446,128)}applicationIdentifier(){return this._getString(574,128)}copyrightFileIdentifier(){return this._getString(702,38)}abstractFileIdentifier(){return this._getString(740,36)}bibliographicFileIdentifier(){return this._getString(776,37)}volumeCreationDate(){return E(this._data,813)}volumeModificationDate(){return E(this._data,830)}volumeExpirationDate(){return E(this._data,847)}volumeEffectiveDate(){return E(this._data,864)}fileStructureVersion(){return this._data[881]}applicationUsed(){return this._data.slice(883,1395)}reserved(){return this._data.slice(1395,2048)}_getString32(t){return this._getString(t,32)}}class w extends D{constructor(t){if(super(t),1!==this.type())throw new o(c.EIO,"Invalid primary volume descriptor.")}name(){return"ISO9660"}_constructRootDirectoryRecord(t){return new U(t,-1)}_getString(t,e){return this._getString(t,e)}}class k extends D{constructor(t){if(super(t),2!==this.type())throw new o(c.EIO,"Invalid supplementary volume descriptor.");const e=this.escapeSequence(),r=e[2];if(37!==e[0]||47!==e[1]||64!==r&&67!==r&&69!==r)throw new o(c.EIO,`Unrecognized escape sequence for SupplementaryVolumeDescriptor: ${e.toString()}`)}name(){return"Joliet"}escapeSequence(){return this._data.slice(88,120)}_constructRootDirectoryRecord(t){return new b(t,-1)}_getString(t,e){return y(this._data,t,e)}}class O{constructor(t,e){this._suEntries=null,this._fileOrDir=null,this._data=t,this._rockRidgeOffset=e}hasRockRidge(){return this._rockRidgeOffset>-1}getRockRidgeOffset(){return this._rockRidgeOffset}rootCheckForRockRidge(t){const e=this.getDirectory(t);this._rockRidgeOffset=e.getDotEntry(t)._getRockRidgeOffset(t),this._rockRidgeOffset>-1&&(this._fileOrDir=null)}length(){return this._data[0]}extendedAttributeRecordLength(){return this._data[1]}lba(){return 2048*this._data.readUInt32LE(2)}dataLength(){return this._data.readUInt32LE(10)}recordingDate(){return R(this._data,18)}fileFlags(){return this._data[25]}fileUnitSize(){return this._data[26]}interleaveGapSize(){return this._data[27]}volumeSequenceNumber(){return this._data.readUInt16LE(28)}identifier(){return this._getString(33,this._data[32])}fileName(t){if(this.hasRockRidge()){const e=this._rockRidgeFilename(t);if(null!==e)return e}const e=this.identifier();if(this.isDirectory(t))return e;const r=e.indexOf(";");return-1===r?e:"."===e[r-1]?e.slice(0,r-1):e.slice(0,r)}isDirectory(t){let e=!!(2&this.fileFlags());return!e&&this.hasRockRidge()&&(e=this.getSUEntries(t).filter(t=>t instanceof G).length>0),e}isSymlink(t){return this.hasRockRidge()&&this.getSUEntries(t).filter(t=>t instanceof B).length>0}getSymlinkPath(t){let e="";const r=this.getSUEntries(t),s=this._getGetString();for(const t of r)if(t instanceof B){const r=t.componentRecords();for(const t of r){const r=t.flags();2&r?e+="./":4&r?e+="../":8&r?e+="/":(e+=t.content(s),1&r||(e+="/"))}if(!t.continueFlag())break}return e.length>1&&"/"===e[e.length-1]?e.slice(0,e.length-1):e}getFile(t){if(this.isDirectory(t))throw new Error("Tried to get a File from a directory.");return null===this._fileOrDir&&(this._fileOrDir=t.slice(this.lba(),this.lba()+this.dataLength())),this._fileOrDir}getDirectory(t){if(!this.isDirectory(t))throw new Error("Tried to get a Directory from a file.");return null===this._fileOrDir&&(this._fileOrDir=this._constructDirectory(t)),this._fileOrDir}getSUEntries(t){return this._suEntries||this._constructSUEntries(t),this._suEntries}_rockRidgeFilename(t){const e=this.getSUEntries(t).filter(t=>t instanceof V);if(0===e.length||6&e[0].flags())return null;let r="";const s=this._getGetString();for(const t of e)if(r+=t.name(s),!(1&t.flags()))break;return r}_constructSUEntries(t){let e=33+this._data[32];e%2==1&&e++,e+=this._rockRidgeOffset,this._suEntries=I(this._data,e,this.length(),t)}_getRockRidgeOffset(t){this._rockRidgeOffset=0;const e=this.getSUEntries(t);if(e.length>0){const t=e[0];if(t instanceof T&&t.checkBytesPass())for(let r=1;r<e.length;r++){const s=e[r];if(s instanceof A||s instanceof P&&s.extensionIdentifier()===p)return t.bytesSkipped()}}return this._rockRidgeOffset=-1,-1}}class U extends O{constructor(t,e){super(t,e)}_getString(t,e){return S(this._data,t,e)}_constructDirectory(t){return new J(this,t)}_getGetString(){return S}}class b extends O{constructor(t,e){super(t,e)}_getString(t,e){return y(this._data,t,e)}_constructDirectory(t){return new Y(this,t)}_getGetString(){return y}}class v{constructor(t){this._data=t}signatureWord(){return this._data.readUInt16BE(0)}signatureWordString(){return S(this._data,0,2)}length(){return this._data[2]}suVersion(){return this._data[3]}}class x extends v{constructor(t){super(t),this._entries=null}continuationLba(){return this._data.readUInt32LE(4)}continuationLbaOffset(){return this._data.readUInt32LE(12)}continuationLength(){return this._data.readUInt32LE(20)}getEntries(t){if(!this._entries){const e=2048*this.continuationLba()+this.continuationLbaOffset();this._entries=I(t,e,this.continuationLength(),t)}return this._entries}}class F extends v{constructor(t){super(t)}}class T extends v{constructor(t){super(t)}checkBytesPass(){return 190===this._data[4]&&239===this._data[5]}bytesSkipped(){return this._data[6]}}class N extends v{constructor(t){super(t)}}class P extends v{constructor(t){super(t)}identifierLength(){return this._data[4]}descriptorLength(){return this._data[5]}sourceLength(){return this._data[6]}extensionVersion(){return this._data[7]}extensionIdentifier(){return S(this._data,8,this.identifierLength())}extensionDescriptor(){return S(this._data,8+this.identifierLength(),this.descriptorLength())}extensionSource(){return S(this._data,8+this.identifierLength()+this.descriptorLength(),this.sourceLength())}}class C extends v{constructor(t){super(t)}extensionSequence(){return this._data[4]}}class A extends v{constructor(t){super(t)}}class z extends v{constructor(t){super(t)}mode(){return this._data.readUInt32LE(4)}fileLinks(){return this._data.readUInt32LE(12)}uid(){return this._data.readUInt32LE(20)}gid(){return this._data.readUInt32LE(28)}inode(){return this._data.readUInt32LE(36)}}class M extends v{constructor(t){super(t)}devTHigh(){return this._data.readUInt32LE(4)}devTLow(){return this._data.readUInt32LE(12)}}class B extends v{constructor(t){super(t)}flags(){return this._data[4]}continueFlag(){return 1&this.flags()}componentRecords(){const t=new Array;let e=5;for(;e<this.length();){const r=new q(this._data.slice(e));t.push(r),e+=r.length()}return t}}class q{constructor(t){this._data=t}flags(){return this._data[0]}length(){return 2+this.componentLength()}componentLength(){return this._data[1]}content(t){return t(this._data,2,this.componentLength())}}class V extends v{constructor(t){super(t)}flags(){return this._data[4]}name(t){return t(this._data,5,this.length()-5)}}class G extends v{constructor(t){super(t)}childDirectoryLba(){return this._data.readUInt32LE(4)}}class W extends v{constructor(t){super(t)}parentDirectoryLba(){return this._data.readUInt32LE(4)}}class $ extends v{constructor(t){super(t)}}class j extends v{constructor(t){super(t)}flags(){return this._data[4]}creation(){return 1&this.flags()?this._longFormDates()?E(this._data,5):R(this._data,5):null}modify(){if(2&this.flags()){const t=1&this.flags()?1:0;return this._longFormDates?E(this._data,5+17*t):R(this._data,5+7*t)}return null}access(){if(4&this.flags()){let t=1&this.flags()?1:0;return t+=2&this.flags()?1:0,this._longFormDates?E(this._data,5+17*t):R(this._data,5+7*t)}return null}backup(){if(16&this.flags()){let t=1&this.flags()?1:0;return t+=2&this.flags()?1:0,t+=4&this.flags()?1:0,this._longFormDates?E(this._data,5+17*t):R(this._data,5+7*t)}return null}expiration(){if(32&this.flags()){let t=1&this.flags()?1:0;return t+=2&this.flags()?1:0,t+=4&this.flags()?1:0,t+=16&this.flags()?1:0,this._longFormDates?E(this._data,5+17*t):R(this._data,5+7*t)}return null}effective(){if(64&this.flags()){let t=1&this.flags()?1:0;return t+=2&this.flags()?1:0,t+=4&this.flags()?1:0,t+=16&this.flags()?1:0,t+=32&this.flags()?1:0,this._longFormDates?E(this._data,5+17*t):R(this._data,5+7*t)}return null}_longFormDates(){return!!this.flags()}}class H extends v{constructor(t){super(t)}virtualSizeHigh(){return this._data.readUInt32LE(4)}virtualSizeLow(){return this._data.readUInt32LE(12)}tableDepth(){return this._data[20]}}class X{constructor(t,e){this._fileList=[],this._fileMap={},this._record=t;let r=t.lba(),s=r+t.dataLength();if(!(2&t.fileFlags())){r=2048*t.getSUEntries(e).filter(t=>t instanceof G)[0].childDirectoryLba(),s=1/0}for(;r<s;){if(0===e[r]){r++;continue}const t=this._constructDirectoryRecord(e.slice(r)),i=t.fileName(e);"\0"!==i&&""!==i?t.hasRockRidge()&&0!==t.getSUEntries(e).filter(t=>t instanceof $).length||(this._fileMap[i]=t,this._fileList.push(i)):s===1/0&&(s=r+t.dataLength()),r+=t.length()}}getRecord(t){return this._fileMap[t]}getFileList(){return this._fileList}getDotEntry(t){return this._constructDirectoryRecord(t.slice(this._record.lba()))}}class J extends X{constructor(t,e){super(t,e)}_constructDirectoryRecord(t){return new U(t,this._record.getRockRidgeOffset())}}class Y extends X{constructor(t,e){super(t,e)}_constructDirectoryRecord(t){return new b(t,this._record.getRockRidgeOffset())}}class K extends l{constructor(t,e=""){super(),this._data=t;let r=!1,s=32768;const i=new Array;for(;!r;){const e=t.slice(s);switch(new L(e).type()){case 1:i.push(new w(e));break;case 2:i.push(new k(e));break;case 255:r=!0}s+=2048}if(0===i.length)throw new o(c.EIO,"Unable to find a suitable volume descriptor.");i.forEach(t=>{this._pvd&&2===this._pvd.type()||(this._pvd=t)}),this._root=this._pvd.rootDirectoryEntry(t),this._name=e}static Create(t,e){try{e(null,new K(t.data,t.name))}catch(t){e(t)}}static isAvailable(){return!0}getName(){let t=`IsoFS${this._name}${this._pvd?`-${this._pvd.name()}`:""}`;return this._root&&this._root.hasRockRidge()&&(t+="-RockRidge"),t}diskSpace(t,e){e(this._data.length,0)}isReadOnly(){return!0}supportsLinks(){return!1}supportsProps(){return!1}supportsSynch(){return!0}statSync(t,e){const r=this._getDirectoryRecord(t);if(null===r)throw o.ENOENT(t);return this._getStats(t,r)}openSync(t,e,r){if(e.isWriteable())throw new o(c.EPERM,t);const s=this._getDirectoryRecord(t);if(!s)throw o.ENOENT(t);if(s.isSymlink(this._data))return this.openSync(a.resolve(t,s.getSymlinkPath(this._data)),e,r);if(s.isDirectory(this._data))throw o.EISDIR(t);{const r=s.getFile(this._data),i=this._getStats(t,s);switch(e.pathExistsAction()){case d.THROW_EXCEPTION:case d.TRUNCATE_FILE:throw o.EEXIST(t);case d.NOP:return new f(this,t,e,i,r);default:throw new o(c.EINVAL,"Invalid FileMode object.")}}}readdirSync(t){const e=this._getDirectoryRecord(t);if(e){if(e.isDirectory(this._data))return e.getDirectory(this._data).getFileList().slice(0);throw o.ENOTDIR(t)}throw o.ENOENT(t)}readFileSync(t,e,r){const s=this.openSync(t,r,420);try{const t=s.getBuffer();return null===e?g(t):t.toString(e)}finally{s.closeSync()}}_getDirectoryRecord(t){if("/"===t)return this._root;const e=t.split("/").slice(1);let r=this._root;for(const t of e){if(!r.isDirectory(this._data))return null;if(!(r=r.getDirectory(this._data).getRecord(t)))return null}return r}_getStats(t,e){if(e.isSymlink(this._data)){const r=a.resolve(t,e.getSymlinkPath(this._data)),s=this._getDirectoryRecord(r);return s?this._getStats(r,s):null}{const t=e.dataLength();let r=365;const s=e.recordingDate().getTime();let i=s,n=s,a=s;if(e.hasRockRidge()){const t=e.getSUEntries(this._data);for(const e of t)if(e instanceof z)r=e.mode();else if(e instanceof j){const t=e.flags();4&t&&(i=e.access().getTime()),2&t&&(n=e.modify().getTime()),1&t&&(a=e.creation().getTime())}}return r&=365,new h(e.isDirectory(this._data)?u.DIRECTORY:u.FILE,t,r,i,n,a)}}}return K.Name="IsoFS",K.Options={data:{type:"object",description:"The ISO file in a buffer",validator:_}},K});
//# sourceMappingURL=../sourcemaps/backend/IsoFS.js.map
