/**
 * skylark-browserfs - A version of browserfs that ported to running on skylarkjs.
 * @author 
 * @version v0.9.0
 * @link 
 * @license MIT
 */
define(["../libs/buffers","../core/file_system","../core/api_error","../core/node_fs_stats","../libs/path","../generic/inode","../generic/preload_file","../core/util"],function(t,e,i,s,r,n,o,a){"use strict";const{BaseFileSystem:h,SynchronousFileSystem:c}=e,{ApiError:d,ErrorCode:l}=i,{FileType:m}=s,{emptyBuffer:u}=a,{PreloadFile:f}=o,{Buffer:y}=t,g="/";let N=null;function p(){return N||(N=y.from("{}"))}function w(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)})}function E(t,e){return!t||(e(t),!1)}function I(t,e,i){return!t||(e.abort(()=>{i(t)}),!1)}class S{constructor(t,e){this.key=t,this.value=e,this.prev=null,this.next=null}}class b{constructor(t){this.limit=t,this.size=0,this.map={},this.head=null,this.tail=null}set(t,e){const i=new S(t,e);this.map[t]?(this.map[t].value=i.value,this.remove(i.key)):this.size>=this.limit&&(delete this.map[this.tail.key],this.size--,this.tail=this.tail.prev,this.tail.next=null),this.setHead(i)}get(t){if(this.map[t]){const e=this.map[t].value,i=new S(t,e);return this.remove(t),this.setHead(i),e}return null}remove(t){const e=this.map[t];e&&(null!==e.prev?e.prev.next=e.next:this.head=e.next,null!==e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.map[t],this.size--)}removeAll(){this.size=0,this.map={},this.head=null,this.tail=null}setHead(t){t.next=this.head,t.prev=null,null!==this.head&&(this.head.prev=t),this.head=t,null===this.tail&&(this.tail=t),this.size++,this.map[t.key]=t}}class D extends f{constructor(t,e,i,s,r){super(t,e,i,s,r)}syncSync(){this.isDirty()&&(this._fs._syncSync(this.getPath(),this.getBuffer(),this.getStats()),this.resetDirty())}closeSync(){this.syncSync()}}class T extends f{constructor(t,e,i,s,r){super(t,e,i,s,r)}sync(t){this.isDirty()?this._fs._sync(this.getPath(),this.getBuffer(),this.getStats(),e=>{e||this.resetDirty(),t(e)}):t()}close(t){this.sync(t)}}return{SimpleSyncRWTransaction:class{constructor(t){this.store=t,this.originalData={},this.modifiedKeys=[]}get(t){const e=this.store.get(t);return this.stashOldValue(t,e),e}put(t,e,i){return this.markModified(t),this.store.put(t,e,i)}del(t){this.markModified(t),this.store.del(t)}commit(){}abort(){for(const t of this.modifiedKeys){const e=this.originalData[t];e?this.store.put(t,e,!0):this.store.del(t)}}stashOldValue(t,e){this.originalData.hasOwnProperty(t)||(this.originalData[t]=e)}markModified(t){-1===this.modifiedKeys.indexOf(t)&&(this.modifiedKeys.push(t),this.originalData.hasOwnProperty(t)||(this.originalData[t]=this.store.get(t)))}},SyncKeyValueFile:D,SyncKeyValueFileSystem:class extends c{static isAvailable(){return!0}constructor(t){super(),this.store=t.store,this.makeRootDirectory()}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!0}empty(){this.store.clear(),this.makeRootDirectory()}renameSync(t,e){const i=this.store.beginTransaction("readwrite"),s=r.dirname(t),n=r.basename(t),o=r.dirname(e),a=r.basename(e),h=this.findINode(i,s),c=this.getDirListing(i,s,h);if(!c[n])throw d.ENOENT(t);const m=c[n];if(delete c[n],0===(o+"/").indexOf(t+"/"))throw new d(l.EBUSY,s);let u,f;if(o===s?(u=h,f=c):(u=this.findINode(i,o),f=this.getDirListing(i,o,u)),f[a]){const t=this.getINode(i,e,f[a]);if(!t.isFile())throw d.EPERM(e);try{i.del(t.id),i.del(f[a])}catch(t){throw i.abort(),t}}f[a]=m;try{i.put(h.id,y.from(JSON.stringify(c)),!0),i.put(u.id,y.from(JSON.stringify(f)),!0)}catch(t){throw i.abort(),t}i.commit()}statSync(t,e){return this.findINode(this.store.beginTransaction("readonly"),t).toStats()}createFileSync(t,e,i){const s=this.store.beginTransaction("readwrite"),r=u(),n=this.commitNewFile(s,t,m.FILE,i,r);return new D(this,t,e,n.toStats(),r)}openFileSync(t,e){const i=this.store.beginTransaction("readonly"),s=this.findINode(i,t),r=i.get(s.id);if(void 0===r)throw d.ENOENT(t);return new D(this,t,e,s.toStats(),r)}unlinkSync(t){this.removeEntry(t,!1)}rmdirSync(t){if(this.readdirSync(t).length>0)throw d.ENOTEMPTY(t);this.removeEntry(t,!0)}mkdirSync(t,e){const i=this.store.beginTransaction("readwrite"),s=y.from("{}");this.commitNewFile(i,t,m.DIRECTORY,e,s)}readdirSync(t){const e=this.store.beginTransaction("readonly");return Object.keys(this.getDirListing(e,t,this.findINode(e,t)))}_syncSync(t,e,i){const s=this.store.beginTransaction("readwrite"),n=this._findINode(s,r.dirname(t),r.basename(t)),o=this.getINode(s,t,n),a=o.update(i);try{s.put(o.id,e,!0),a&&s.put(n,o.toBuffer(),!0)}catch(t){throw s.abort(),t}s.commit()}makeRootDirectory(){const t=this.store.beginTransaction("readwrite");if(void 0===t.get(g)){const e=(new Date).getTime(),i=new n(w(),4096,511|m.DIRECTORY,e,e,e);t.put(i.id,p(),!1),t.put(g,i.toBuffer(),!1),t.commit()}}_findINode(t,e,i){const s=s=>{const n=this.getDirListing(t,e,s);if(n[i])return n[i];throw d.ENOENT(r.resolve(e,i))};return"/"===e?""===i?g:s(this.getINode(t,e,g)):s(this.getINode(t,e+r.sep+i,this._findINode(t,r.dirname(e),r.basename(e))))}findINode(t,e){return this.getINode(t,e,this._findINode(t,r.dirname(e),r.basename(e)))}getINode(t,e,i){const s=t.get(i);if(void 0===s)throw d.ENOENT(e);return n.fromBuffer(s)}getDirListing(t,e,i){if(!i.isDirectory())throw d.ENOTDIR(e);const s=t.get(i.id);if(void 0===s)throw d.ENOENT(e);return JSON.parse(s.toString())}addNewNode(t,e){let i;for(;;)try{return i=w(),t.put(i,e,!1),i}catch(t){}throw new d(l.EIO,"Unable to commit data to key-value store.")}commitNewFile(t,e,i,s,o){const a=r.dirname(e),h=r.basename(e),c=this.findINode(t,a),l=this.getDirListing(t,a,c),m=(new Date).getTime();if("/"===e)throw d.EEXIST(e);if(l[h])throw d.EEXIST(e);let u;try{const e=this.addNewNode(t,o);u=new n(e,o.length,s|i,m,m,m);const r=this.addNewNode(t,u.toBuffer());l[h]=r,t.put(c.id,y.from(JSON.stringify(l)),!0)}catch(e){throw t.abort(),e}return t.commit(),u}removeEntry(t,e){const i=this.store.beginTransaction("readwrite"),s=r.dirname(t),n=this.findINode(i,s),o=this.getDirListing(i,s,n),a=r.basename(t);if(!o[a])throw d.ENOENT(t);const h=o[a];delete o[a];const c=this.getINode(i,t,h);if(!e&&c.isDirectory())throw d.EISDIR(t);if(e&&!c.isDirectory())throw d.ENOTDIR(t);try{i.del(c.id),i.del(h),i.put(n.id,y.from(JSON.stringify(o)),!0)}catch(t){throw i.abort(),t}i.commit()}},AsyncKeyValueFile:T,AsyncKeyValueFileSystem:class extends h{constructor(t){super(),this._cache=null,t>0&&(this._cache=new b(t))}static isAvailable(){return!0}init(t,e){this.store=t,this.makeRootDirectory(e)}getName(){return this.store.name()}isReadOnly(){return!1}supportsSymlinks(){return!1}supportsProps(){return!1}supportsSynch(){return!1}empty(t){this._cache&&this._cache.removeAll(),this.store.clear(e=>{E(e,t)&&this.makeRootDirectory(t)})}rename(t,e,i){if(this._cache){const t=this._cache;this._cache=null,t.removeAll();const e=i;i=(i=>{this._cache=t,e(i)})}const s=this.store.beginTransaction("readwrite"),n=r.dirname(t),o=r.basename(t),a=r.dirname(e),h=r.basename(e),c={},m={};let u=!1;if(0===(a+"/").indexOf(t+"/"))return i(new d(l.EBUSY,n));const f=()=>{if(u||!m.hasOwnProperty(n)||!m.hasOwnProperty(a))return;const r=m[n],l=c[n],f=m[a],g=c[a];if(r[o]){const t=r[o];delete r[o];const c=()=>{f[h]=t,s.put(l.id,y.from(JSON.stringify(r)),!0,t=>{I(t,s,i)&&(n===a?s.commit(i):s.put(g.id,y.from(JSON.stringify(f)),!0,t=>{I(t,s,i)&&s.commit(i)}))})};f[h]?this.getINode(s,e,f[h],(t,r)=>{I(t,s,i)&&(r.isFile()?s.del(r.id,t=>{I(t,s,i)&&s.del(f[h],t=>{I(t,s,i)&&c()})}):s.abort(t=>{i(d.EPERM(e))}))}):c()}else i(d.ENOENT(t))},g=t=>{this.findINodeAndDirListing(s,t,(e,r,n)=>{e?u||(u=!0,s.abort(()=>{i(e)})):(c[t]=r,m[t]=n,f())})};g(n),n!==a&&g(a)}stat(t,e,i){const s=this.store.beginTransaction("readonly");this.findINode(s,t,(t,e)=>{E(t,i)&&i(null,e.toStats())})}createFile(t,e,i,s){const r=this.store.beginTransaction("readwrite"),n=u();this.commitNewFile(r,t,m.FILE,i,n,(i,r)=>{E(i,s)&&s(null,new T(this,t,e,r.toStats(),n))})}openFile(t,e,i){const s=this.store.beginTransaction("readonly");this.findINode(s,t,(r,n)=>{E(r,i)&&s.get(n.id,(s,r)=>{E(s,i)&&(void 0===r?i(d.ENOENT(t)):i(null,new T(this,t,e,n.toStats(),r)))})})}unlink(t,e){this.removeEntry(t,!1,e)}rmdir(t,e){this.readdir(t,(i,s)=>{i?e(i):s.length>0?e(d.ENOTEMPTY(t)):this.removeEntry(t,!0,e)})}mkdir(t,e,i){const s=this.store.beginTransaction("readwrite"),r=y.from("{}");this.commitNewFile(s,t,m.DIRECTORY,e,r,i)}readdir(t,e){const i=this.store.beginTransaction("readonly");this.findINode(i,t,(s,r)=>{E(s,e)&&this.getDirListing(i,t,r,(t,i)=>{E(t,e)&&e(null,Object.keys(i))})})}_sync(t,e,i,s){const n=this.store.beginTransaction("readwrite");this._findINode(n,r.dirname(t),r.basename(t),(r,o)=>{I(r,n,s)&&this.getINode(n,t,o,(t,r)=>{if(I(t,n,s)){const t=r.update(i);n.put(r.id,e,!0,e=>{I(e,n,s)&&(t?n.put(o,r.toBuffer(),!0,t=>{I(t,n,s)&&n.commit(s)}):n.commit(s))})}})})}makeRootDirectory(t){const e=this.store.beginTransaction("readwrite");e.get(g,(i,s)=>{if(i||void 0===s){const i=(new Date).getTime(),s=new n(w(),4096,511|m.DIRECTORY,i,i,i);e.put(s.id,p(),!1,i=>{I(i,e,t)&&e.put(g,s.toBuffer(),!1,i=>{i?e.abort(()=>{t(i)}):e.commit(t)})})}else e.commit(t)})}_findINode(t,e,i,s){if(this._cache){const t=this._cache.get(r.join(e,i));if(t)return s(null,t)}const n=(t,n,o)=>{if(t)s(t);else if(o[i]){const t=o[i];this._cache&&this._cache.set(r.join(e,i),t),s(null,t)}else s(d.ENOENT(r.resolve(e,i)))};"/"===e?""===i?(this._cache&&this._cache.set(r.join(e,i),g),s(null,g)):this.getINode(t,e,g,(i,r)=>{E(i,s)&&this.getDirListing(t,e,r,(t,e)=>{n(t,0,e)})}):this.findINodeAndDirListing(t,e,n)}findINode(t,e,i){this._findINode(t,r.dirname(e),r.basename(e),(s,r)=>{E(s,i)&&this.getINode(t,e,r,i)})}getINode(t,e,i,s){t.get(i,(t,i)=>{E(t,s)&&(void 0===i?s(d.ENOENT(e)):s(null,n.fromBuffer(i)))})}getDirListing(t,e,i,s){i.isDirectory()?t.get(i.id,(t,i)=>{if(E(t,s))try{s(null,JSON.parse(i.toString()))}catch(t){s(d.ENOENT(e))}}):s(d.ENOTDIR(e))}findINodeAndDirListing(t,e,i){this.findINode(t,e,(s,r)=>{E(s,i)&&this.getDirListing(t,e,r,(t,e)=>{E(t,i)&&i(null,r,e)})})}addNewNode(t,e,i){let s,r=0;const n=()=>{5==++r?i(new d(l.EIO,"Unable to commit data to key-value store.")):(s=w(),t.put(s,e,!1,(t,e)=>{t||!e?n():i(null,s)}))};n()}commitNewFile(t,e,i,s,o,a){const h=r.dirname(e),c=r.basename(e),l=(new Date).getTime();if("/"===e)return a(d.EEXIST(e));this.findINodeAndDirListing(t,h,(r,h,m)=>{I(r,t,a)&&(m[c]?t.abort(()=>{a(d.EEXIST(e))}):this.addNewNode(t,o,(e,r)=>{if(I(e,t,a)){const e=new n(r,o.length,s|i,l,l,l);this.addNewNode(t,e.toBuffer(),(i,s)=>{I(i,t,a)&&(m[c]=s,t.put(h.id,y.from(JSON.stringify(m)),!0,i=>{I(i,t,a)&&t.commit(i=>{I(i,t,a)&&a(null,e)})}))})}}))})}removeEntry(t,e,i){this._cache&&this._cache.remove(t);const s=this.store.beginTransaction("readwrite"),n=r.dirname(t),o=r.basename(t);this.findINodeAndDirListing(s,n,(r,n,a)=>{if(I(r,s,i))if(a[o]){const r=a[o];delete a[o],this.getINode(s,t,r,(o,h)=>{I(o,s,i)&&(!e&&h.isDirectory()?s.abort(()=>{i(d.EISDIR(t))}):e&&!h.isDirectory()?s.abort(()=>{i(d.ENOTDIR(t))}):s.del(h.id,t=>{I(t,s,i)&&s.del(r,t=>{I(t,s,i)&&s.put(n.id,y.from(JSON.stringify(a)),!0,t=>{I(t,s,i)&&s.commit(i)})})}))})}else s.abort(()=>{i(d.ENOENT(t))})})}}}});
//# sourceMappingURL=../sourcemaps/generic/key_value_filesystem.js.map
